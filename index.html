<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Muminji Ward ‚Äì Agent Access</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
    background:#f5f7fa;
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
}
.card{
    border-radius:16px;
    border: none;
}
.form-control, .form-select{
    text-align: left;
    border-radius:10px;
    padding: 0.6rem 0.75rem;
}
.btn-toggle-pw {
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
    border: 1px solid #ced4da;
    background: white;
    cursor: pointer;
}
.input-group .form-control {
    border-right: 0;
}
.summary-box{
    background:#e9f2ff;
    padding:10px;
    border-radius:8px;
}
.reg-panel, .login-panel {
    transition: all 0.2s ease;
}
.form-text a {
    text-decoration: none;
    font-weight: 500;
}

/* Candidate card styles */
.candidate-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
}

.candidate-card:hover {
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.candidate-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #dee2e6;
    background: #ffffff;
}

.candidate-info {
    flex: 1;
}

.candidate-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: #212529;
}

.candidate-party {
    font-size: 0.85rem;
    color: #6c757d;
}

.candidate-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 5px;
}

.candidate-input-group input {
    width: 120px;
    text-align: center;
}

@media (max-width: 576px) {
    .candidate-card {
        flex-direction: column;
        text-align: center;
    }
    
    .candidate-input-group {
        justify-content: center;
    }
}
</style>
</head>
<body>

<div class="container mt-4 mb-4">
<div class="row justify-content-center">
  <div class="col-lg-7 col-md-9">

    <!-- registration card (shown by default) -->
    <div id="registrationCard" class="card shadow p-4 mb-4 reg-panel">
        <h4 class="text-center mb-4">üìã Agent Registration</h4>

        <!-- full name -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Full Name</label>
            <input type="text" id="regFullName" class="form-control" placeholder="e.g., John Mwangi" autocomplete="name">
        </div>

        <!-- polling station dropdown (from firebase list) -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Polling Station</label>
            <select id="regStationSelect" class="form-select" required>
                <option value="" disabled selected>‚Äì select your polling station ‚Äì</option>
            </select>
        </div>

        <!-- email -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Email address</label>
            <input type="email" id="regEmail" class="form-control" placeholder="agent@example.com" autocomplete="email">
        </div>

        <!-- password with view toggle -->
        <div class="mb-2">
            <label class="form-label fw-semibold">Password</label>
            <div class="input-group">
                <input type="password" id="regPassword" class="form-control" placeholder="at least 6 characters" autocomplete="new-password">
                <button class="btn btn-outline-secondary btn-toggle-pw" type="button" onclick="togglePassword('regPassword', this)">üëÅÔ∏è</button>
            </div>
        </div>

        <!-- confirm password with toggle -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Confirm password</label>
            <div class="input-group">
                <input type="password" id="regConfirmPw" class="form-control" placeholder="re-enter password" autocomplete="off">
                <button class="btn btn-outline-secondary btn-toggle-pw" type="button" onclick="togglePassword('regConfirmPw', this)">üëÅÔ∏è</button>
            </div>
            <div id="pwMatchFeedback" class="form-text text-danger small"></div>
        </div>

        <!-- register button -->
        <button class="btn btn-primary w-100 py-2 fw-semibold" onclick="handleRegister()">üìù Register as Agent</button>

        <div class="text-center mt-3">
            <span class="text-muted">Already have an account?</span>
            <a href="#" id="showLoginLink" class="text-decoration-none fw-medium">Log in</a>
        </div>

        <div id="regMessage" class="mt-3 text-center small"></div>
    </div>

    <!-- login card (hidden initially) -->
    <div id="loginCard" class="card shadow p-4 login-panel" style="display: none;">
        <h4 class="text-center mb-4">üîê Agent Login</h4>

        <!-- login email -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Email</label>
            <input type="email" id="loginEmail" class="form-control" placeholder="agent@example.com" autocomplete="email">
        </div>

        <!-- password with toggle -->
        <div class="mb-4">
            <label class="form-label fw-semibold">Password</label>
            <div class="input-group">
                <input type="password" id="loginPassword" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                <button class="btn btn-outline-secondary btn-toggle-pw" type="button" onclick="togglePassword('loginPassword', this)">üëÅÔ∏è</button>
            </div>
        </div>

        <button class="btn btn-success w-100 py-2 fw-semibold" onclick="handleLogin()">üîì Log in</button>

        <div class="text-center mt-3">
            <span class="text-muted">Not registered?</span>
            <a href="#" id="showRegisterLink" class="text-decoration-none fw-medium">Create account</a>
        </div>

        <div id="loginMessage" class="mt-3 text-center small"></div>
    </div>

    <!-- result submission panel (visible only after registration/login demo) -->
    <div id="submissionPanel" class="card shadow p-4 mt-3" style="display: none;">
        <div class="d-flex align-items-center gap-2 mb-3">
            <span class="fw-bold" id="greetingUser"></span>
            <span class="ms-auto">üìç <span id="assignedStationDisplay"></span></span>
        </div>
        <h5 class="text-center mb-3">üó≥Ô∏è Submit results for your station</h5>

        <!-- polling station fixed (hidden field) ‚Äì no reselection needed -->
        <div class="mb-3">
            <label class="form-label"><strong>Polling Station (fixed)</strong></label>
            <input type="text" id="fixedStationName" class="form-control" readonly>
        </div>
        <div class="mb-3">
            <label class="form-label"><strong>Registered Voters</strong></label>
            <input type="number" id="registeredVoters" class="form-control" value="0" readonly>
        </div>

        <!-- candidates section with profile pictures -->
        <h6 class="mb-3">Candidates</h6>
        <div id="candidates"></div>

        <div class="mb-3">
            <label>Rejected Votes</label>
            <input type="number" class="form-control vote-input" id="rejected" value="0" min="0">
        </div>

        <hr>

        <div class="summary-box mb-3">
            <p><strong>Total Valid Votes:</strong> <span id="validVotes">0</span></p>
            <p><strong>Total Votes Cast:</strong> <span id="totalVotes">0</span></p>
            <p><strong>Turnout %:</strong> <span id="turnout">0</span>%</p>
        </div>

        <button class="btn btn-success w-100" onclick="submitResults()">Submit Results</button>
        <div id="message" class="mt-3 text-center"></div>
    </div>

  </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// firebase config
const firebaseConfig = {
    apiKey: "AIzaSyCJEJGa_GBufklAc7gl9-TjjBbpxao7_J8",
    authDomain: "tallying-9df93.firebaseapp.com",
    projectId: "tallying-9df93",
    storageBucket: "tallying-9df93.firebasestorage.app",
    messagingSenderId: "753383473885",
    appId: "1:753383473885:web:233b745b693f3af1985134",
    measurementId: "G-M8M50CKTN3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- candidate list with profile photos ----------
const candidates = [
    {
        name: "Boniface Kariuki (DEP)",
        party: "DEP",
        photo: "https://i.ibb.co/bMQZfjTr/IMG-20260205-WA0007.jpgK" // Replace with actual photo URL
    },
    {
        name: "John Nyaga (UPA)",
        party: "UPA",
        photo: "https://via.placeholder.com/60/28a745/ffffff?text=JN" // Replace with actual photo URL
    },
    {
        name: "Cosmas Njeru (NEDP)",
        party: "NEDP",
        photo: "https://via.placeholder.com/60/dc3545/ffffff?text=CN" // Replace with actual photo URL
    },
    {
        name: "Joseph Ngari (UMP)",
        party: "UMP",
        photo: "https://via.placeholder.com/60/ffc107/000000?text=JN" // Replace with actual photo URL
    },
    {
        name: "Peterson Njeru (UDA)",
        party: "UDA",
        photo: "https://via.placeholder.com/60/17a2b8/ffffff?text=PN" // Replace with actual photo URL
    },
    {
        name: "Charles Kiura (TWA)",
        party: "TWA",
        photo: "https://via.placeholder.com/60/6c757d/ffffff?text=CK" // Replace with actual photo URL
    },
    {
        name: "Zachary Mbogo (KMM)",
        party: "KMM",
        photo: "https://via.placeholder.com/60/343a40/ffffff?text=ZM" // Replace with actual photo URL
    }
];

// render candidate inputs inside submission panel with profile pictures
const container = document.getElementById("candidates");
candidates.forEach((candidate, index)=>{
    container.innerHTML += `
    <div class="candidate-card">
        <img src="${candidate.photo}" alt="${candidate.name}" class="candidate-avatar" onerror="this.src='https://via.placeholder.com/60/6c757d/ffffff?text=?'">
        <div class="candidate-info">
            <div class="candidate-name">${candidate.name}</div>
            <div class="candidate-party">Party: ${candidate.party}</div>
            <div class="candidate-input-group">
                <label class="small">Votes:</label>
                <input type="number" class="form-control form-control-sm vote-input candidate" min="0" value="0" data-candidate="${candidate.name}">
            </div>
        </div>
    </div>`;
});

// vote calculation function
function calculateTotals(){
    let registered = parseInt(document.getElementById("registeredVoters").value) || 0;
    let rejected = parseInt(document.getElementById("rejected").value) || 0;

    let valid = 0;
    document.querySelectorAll(".candidate").forEach(input=>{
        valid += parseInt(input.value) || 0;
    });

    let total = valid + rejected;
    let turnout = registered ? ((total / registered) * 100).toFixed(2) : 0;

    document.getElementById("validVotes").innerText = valid;
    document.getElementById("totalVotes").innerText = total;
    document.getElementById("turnout").innerText = turnout;
}

// attach listeners to vote inputs
const attachVoteListeners = () => {
    document.querySelectorAll(".vote-input").forEach(input => {
        input.removeEventListener("input", calculateTotals);
        input.addEventListener("input", calculateTotals);
    });
};
attachVoteListeners();

// ---------- polling stations ----------
const pollingStations = [
  { id: "MM001", name: "Kivue Primary School", voters: 686 },
  { id: "MM002", name: "Mbarwari Primary School", voters: 586 },
  { id: "MM003", name: "Cieria Primary School", voters: 492 },
  { id: "MM004", name: "Ndutori Primary School", voters: 486 },
  { id: "MM005", name: "Michegethiu Primary School", voters: 471 },
  { id: "MM006", name: "Gangara Primary School A", voters: 469 },
  { id: "MM007", name: "Gangara Primary School B", voters: 469 },
  { id: "MM008", name: "Nguthi Primary School", voters: 441 },
  { id: "MM009", name: "Kiamungongo Primary School", voters: 435 },
  { id: "MM010", name: "Itiira Primary School A", voters: 417 },
  { id: "MM011", name: "Itiira Primary School B", voters: 416 },
  { id: "MM012", name: "Karimari Primary School", voters: 404 },
  { id: "MM013", name: "Ngiir√Æ Primary School A", voters: 402 },
  { id: "MM014", name: "Ngiir√Æ Primary School B", voters: 401 },
  { id: "MM015", name: "Karambari Primary School", voters: 386 },
  { id: "MM016", name: "Kirie Primary School A", voters: 377 },
  { id: "MM017", name: "Kirie Primary School B", voters: 377 },
  { id: "MM018", name: "Gatakari Primary School", voters: 338 },
  { id: "MM019", name: "Rwagori Primary School", voters: 278 },
  { id: "MM020", name: "Mukororia Primary School", voters: 272 },
  { id: "MM021", name: "Kavui Primary School", voters: 232 },
  { id: "MM022", name: "Kandomba Primary School", voters: 229 },
  { id: "MM023", name: "Gatothia Primary School", voters: 164 },
  { id: "MM024", name: "Kianjogu Primary School", voters: 148 },
  { id: "MM025", name: "Kathutheri Primary School", voters: 142 },
  { id: "MM026", name: "Mianjatiri Primary School", voters: 131 }
];

// populate registration dropdown
const regStationSelect = document.getElementById("regStationSelect");
pollingStations.forEach(station => {
    const option = document.createElement("option");
    option.value = station.id;
    option.setAttribute("data-voters", station.voters);
    option.textContent = station.name;
    regStationSelect.appendChild(option);
});

// Global variables for current session
window.currentAgentStationId = null;
window.currentAgentStationName = null;

// Toggle password visibility
window.togglePassword = function(inputId, btn) {
    const input = document.getElementById(inputId);
    if (input.type === "password") {
        input.type = "text";
        btn.innerText = "üîí";
    } else {
        input.type = "password";
        btn.innerText = "üëÅÔ∏è";
    }
};

// Handle registration
window.handleRegister = async function() {
    const fullName = document.getElementById("regFullName").value.trim();
    const stationSelect = document.getElementById("regStationSelect");
    const stationId = stationSelect.value;
    const stationName = stationSelect.options[stationSelect.selectedIndex]?.text || "";
    const email = document.getElementById("regEmail").value.trim();
    const password = document.getElementById("regPassword").value;
    const confirmPw = document.getElementById("regConfirmPw").value;
    const msgDiv = document.getElementById("regMessage");
    const pwFeedback = document.getElementById("pwMatchFeedback");

    // Clear previous messages
    msgDiv.innerHTML = "";
    pwFeedback.innerHTML = "";

    // Validation
    if (!fullName || !stationId || !email || !password || !confirmPw) {
        msgDiv.innerHTML = "<span class='text-danger'>All fields required.</span>";
        return;
    }

    if (password !== confirmPw) {
        pwFeedback.innerHTML = "Passwords do not match!";
        return;
    }

    if (password.length < 6) {
        msgDiv.innerHTML = "<span class='text-danger'>Password must be at least 6 characters.</span>";
        return;
    }

    try {
        // Create user in Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Save agent data in Firestore using UID
        await setDoc(doc(db, "agents", user.uid), {
            fullName,
            email: email.toLowerCase(),
            stationId,
            stationName,
            createdAt: serverTimestamp()
        });

        msgDiv.innerHTML = "<span class='text-success'>Registration successful! You can now log in.</span>";
        
        // Clear form
        document.getElementById("regFullName").value = "";
        document.getElementById("regEmail").value = "";
        document.getElementById("regPassword").value = "";
        document.getElementById("regConfirmPw").value = "";
        stationSelect.selectedIndex = 0;

    } catch (error) {
        console.error("Registration error:", error);
        msgDiv.innerHTML = `<span class='text-danger'>${error.message}</span>`;
    }
};

// Handle login
window.handleLogin = async function() {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;
    const msgDiv = document.getElementById("loginMessage");

    msgDiv.innerHTML = "";

    if (!email || !password) {
        msgDiv.innerHTML = "<span class='text-danger'>Enter email and password.</span>";
        return;
    }

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Get agent data from Firestore
        const agentDoc = await getDoc(doc(db, "agents", user.uid));
        
        if (!agentDoc.exists()) {
            msgDiv.innerHTML = "<span class='text-danger'>Agent record not found. Please contact admin.</span>";
            return;
        }

        const agentData = agentDoc.data();
        
        // Find the station details
        const station = pollingStations.find(s => s.id === agentData.stationId);
        
        if (!station) {
            msgDiv.innerHTML = "<span class='text-danger'>Station not found.</span>";
            return;
        }

        // Set current session variables
        window.currentAgentStationId = agentData.stationId;
        window.currentAgentStationName = station.name;

        // Update UI
        document.getElementById("greetingUser").innerText = `üë§ ${agentData.fullName}`;
        document.getElementById("assignedStationDisplay").innerText = station.name;
        document.getElementById("fixedStationName").value = station.name;
        document.getElementById("registeredVoters").value = station.voters;

        // Show submission panel
        document.getElementById("registrationCard").style.display = "none";
        document.getElementById("loginCard").style.display = "none";
        document.getElementById("submissionPanel").style.display = "block";

        // Re-attach vote listeners (in case DOM was updated)
        attachVoteListeners();
        
        // Reset totals
        calculateTotals();

    } catch (error) {
        console.error("Login error:", error);
        msgDiv.innerHTML = `<span class='text-danger'>${error.message}</span>`;
    }
};

// Submit results to Firestore
window.submitResults = async function() {
    const messageBox = document.getElementById("message");
    messageBox.innerHTML = "";

    try {
        const stationId = window.currentAgentStationId;
        const stationName = window.currentAgentStationName;
        
        if (!stationId || !stationName) {
            messageBox.innerHTML = "<span class='text-danger'>Station missing. Please log in again.</span>";
            return;
        }

        const registered = parseInt(document.getElementById("registeredVoters").value);
        const rejected = parseInt(document.getElementById("rejected").value) || 0;
        
        // Collect candidate votes
        let votes = {};
        let validTotal = 0;
        
        document.querySelectorAll(".candidate").forEach((input) => {
            const candidateName = input.getAttribute("data-candidate");
            const voteValue = parseInt(input.value) || 0;
            votes[candidateName] = voteValue;
            validTotal += voteValue;
        });

        const totalCast = validTotal + rejected;
        const turnout = registered ? (totalCast / registered) * 100 : 0;

        // Validation
        if (totalCast > registered) {
            messageBox.innerHTML = "<span class='text-danger'>Error: Total votes exceed registered voters!</span>";
            return;
        }

        // Check if results already submitted
        const existingResults = await getDoc(doc(db, "results", stationId));
        if (existingResults.exists()) {
            messageBox.innerHTML = "<span class='text-danger'>Results already submitted for this station!</span>";
            return;
        }

        // Submit results
        await setDoc(doc(db, "results", stationId), {
            stationId: stationId,
            stationName: stationName,
            registeredVoters: registered,
            votes: votes,
            rejected: rejected,
            totalValid: validTotal,
            totalCast: totalCast,
            turnout: turnout,
            status: "submitted",
            submittedAt: serverTimestamp(),
            submittedBy: auth.currentUser?.uid || "unknown"
        });

        messageBox.innerHTML = "<span class='text-success'>Results Submitted Successfully!</span>";

        // Optional: disable further submission
        document.querySelectorAll("input").forEach(input => input.disabled = true);
        document.querySelector("button[onclick='submitResults()']").disabled = true;

    } catch (error) {
        console.error("Submit error:", error);
        messageBox.innerHTML = `<span class='text-danger'>Error: ${error.message}</span>`;
    }
};

// UI toggle between reg/login
document.getElementById("showLoginLink").addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById("registrationCard").style.display = "none";
    document.getElementById("loginCard").style.display = "block";
});

document.getElementById("showRegisterLink").addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("registrationCard").style.display = "block";
});

// Password match checking
document.getElementById("regConfirmPw").addEventListener("input", function() {
    const password = document.getElementById("regPassword").value;
    const confirmPw = this.value;
    const feedback = document.getElementById("pwMatchFeedback");
    
    if (confirmPw && password !== confirmPw) {
        feedback.innerHTML = "Passwords do not match!";
    } else {
        feedback.innerHTML = "";
    }
});

// Check auth state on load
onAuthStateChanged(auth, (user) => {
    if (user) {
        // User is signed in, you might want to auto-load their data
        console.log("User is signed in:", user.email);
    }
});

</script>

</body>
</html>
